name: Deploy to OCI

on:
  push:
    branches:
      - main  # main 브랜치에 push 시 자동 배포
  workflow_dispatch:  # 수동 트리거 가능

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.OCI_SSH_PRIVATE_KEY }}

      - name: Add OCI host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.OCI_HOST }} >> ~/.ssh/known_hosts

      - name: Install rsync (local)
        run: |
          sudo apt-get update
          sudo apt-get install -y rsync

      - name: Install dependencies on OCI
        run: |
          ssh ${{ secrets.OCI_USER }}@${{ secrets.OCI_HOST }} << 'EOF'
            # rsync 설치 (조건부 apt-get update)
            if ! command -v rsync &> /dev/null; then
              echo "Installing rsync..."
              sudo apt-get update -qq
              sudo apt-get install -y rsync
            fi

            # Docker 설치 확인 (설치 시에만 update)
            if ! command -v docker &> /dev/null; then
              echo "Installing Docker..."
              curl -fsSL https://get.docker.com -o get-docker.sh
              sudo sh get-docker.sh
              sudo usermod -aG docker $USER
              rm get-docker.sh
            fi

            # Docker Compose 설치 확인
            if ! command -v docker-compose &> /dev/null && ! docker compose version &> /dev/null; then
              echo "Installing Docker Compose..."
              sudo apt-get update -qq
              sudo apt-get install -y docker-compose-plugin
            fi

            echo "All dependencies verified"
          EOF

      - name: Create .env file on OCI
        run: |
          ssh ${{ secrets.OCI_USER }}@${{ secrets.OCI_HOST }} << 'EOF'
            cd ~/CatchUp-Github-Worker

            # .env 파일 생성 (GitHub Secrets에서 주입)
            cat > .env << 'ENVEOF'
          APP_ENV=${{ secrets.APP_ENV }}
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          MEILI_URL=${{ secrets.MEILI_URL }}
          MEILI_MASTER_KEY=${{ secrets.MEILI_MASTER_KEY }}
          GITHUB_TOKEN=${{ secrets.GH_TOKEN }}
          RABBITMQ_URL=${{ secrets.RABBITMQ_URL }}
          MAX_ZIP_SIZE_MB=${{ secrets.MAX_ZIP_SIZE_MB }}
          ENVEOF
          EOF

      - name: Deploy to OCI via rsync
        run: |
          # 코드를 OCI 인스턴스로 동기화 (.env 제외)
          rsync -avz --delete \
            --exclude '.git' \
            --exclude '.env' \
            --exclude 'venv' \
            --exclude '.venv' \
            --exclude '__pycache__' \
            --exclude '*.pyc' \
            --exclude '.idea' \
            --exclude 'logs' \
            ./ ${{ secrets.OCI_USER }}@${{ secrets.OCI_HOST }}:~/CatchUp-Github-Worker/

      - name: Deploy with Docker Compose
        run: |
          ssh ${{ secrets.OCI_USER }}@${{ secrets.OCI_HOST }} << 'EOF'
            cd ~/CatchUp-Github-Worker

            # 기존 컨테이너 중지
            echo "Stopping containers..."
            docker compose down

            # Dangling 이미지만 정리 (캐시 보존)
            echo "Cleaning up dangling images..."
            docker image prune -f

            # BuildKit 활성화로 빌드 속도 향상
            export DOCKER_BUILDKIT=1
            export COMPOSE_DOCKER_CLI_BUILD=1

            # Docker Compose로 서비스 빌드 및 시작 (캐시 활용)
            echo "Building images with cache (BuildKit enabled)..."
            docker compose build

            echo "Starting services..."
            docker compose up -d

            # 서비스가 시작될 때까지 대기
            echo "Waiting for services to start..."
            sleep 5

            # 컨테이너 상태 확인
            echo "=== Container Status ==="
            docker compose ps

            # Worker 로그 확인
            echo "=== Worker Logs ==="
            docker compose logs --tail=50 worker

            echo "✅ Deployment completed successfully!"
          EOF

      - name: Deployment completed
        run: |
          echo " Deployment to OCI completed successfully!"